#include "adc.h"

/**********************************************************************************/
/********************************** Variables *************************************/
/**********************************************************************************/

/*********************************** Tickers **************************************/
ticker_t adc_ticker_capture;
ticker_t adc_ticker_send_data;
/**********************************************************************************/

/******************************* ADC de la HAL ***********************************/
extern ADC_HandleTypeDef hadc1;
/**********************************************************************************/

/***************************** Bufferes de datos **********************************/
adc_buffer_t adc_buffer;
/**********************************************************************************/

/**************************** Variables auxiliares ********************************/
extern uint8_t system_aux_i;	// Auxiliares de iteraci√≥n
/**********************************************************************************/

/**********************************************************************************/
/**********************************************************************************/
/**********************************************************************************/

/**********************************************************************************/
/********************************** Funciones *************************************/
/**********************************************************************************/
void adc_init(void)
{
	/***********************************************************************************/
	/************************* Inicializacion de los bufferes **************************/
	/***********************************************************************************/

	/***********************************************************************************/
	/***********************************************************************************/
	/***********************************************************************************/

	/***********************************************************************************/
	/************************** Inicializacion de los tickers **************************/
	/***********************************************************************************/

	/************************* Ticker para la captura de datos *************************/
	adc_ticker_capture.ms_count = 0;
	adc_ticker_capture.ms_max = 2;
	adc_ticker_capture.calls = 0;
	adc_ticker_capture.priority = TICKER_LOW_PRIORITY;
	adc_ticker_capture.ticker_function = adc_capture;
	adc_ticker_capture.active = TICKER_ACTIVE;

	ticker_new(&adc_ticker_capture);
	/***********************************************************************************/

	// Se inicia la conversion del ADC en DMA
	HAL_ADC_Start_DMA(&hadc1, (uint32_t *)(&adc_buffer.data), 6);

	/***********************************************************************************/
	/***********************************************************************************/
	/***********************************************************************************/
}

void adc_capture(void)
{
	// Se inicia la conversion del ADC en DMA
	HAL_ADC_Start_DMA(&hadc1, (uint32_t *)(&adc_buffer.data), 6);
}
/***********************************************************************************/
/***********************************************************************************/
/***********************************************************************************/

/**********************************************************************************/
/********************************** Callbacks *************************************/
/**********************************************************************************/
void HAL_ADC_ConvCpltCallback(ADC_HandleTypeDef* hadc)
{
	// Se calcula la media movil
	for (system_aux_i = 0 ; system_aux_i < 6 ; system_aux_i++)
	{
		adc_buffer.mean[system_aux_i] = (adc_buffer.mean[system_aux_i] + adc_buffer.data[system_aux_i]) / 2;
	}
}
/***********************************************************************************/
/***********************************************************************************/
/***********************************************************************************/
