#include "adc.h"

/**********************************************************************************/
/********************************** Variables *************************************/
/**********************************************************************************/

/*********************************** Tickers **************************************/
ticker_t adc_ticker_capture;

ticker_t adc_ticker_send_data;
/**********************************************************************************/

/******************************* ADC de la HAL ***********************************/
extern ADC_HandleTypeDef hadc1;
/**********************************************************************************/

/***************************** Bufferes de datos **********************************/
adc_buffer_t adc_buffer;
/**********************************************************************************/

/**************************** Variables auxiliares ********************************/
extern uint8_t system_aux_i, system_aux_j;	// Auxiliares de ateraci√≥n
/**********************************************************************************/

/**********************************************************************************/
/**********************************************************************************/
/**********************************************************************************/

/**********************************************************************************/
/********************************** Funciones *************************************/
/**********************************************************************************/
void adc_init(void)
{
	/***********************************************************************************/
	/************************* Inicializacion de los bufferes **************************/
	/***********************************************************************************/

	/************************** Buffer de captura de datos ADC *************************/
	memset((uint16_t *)(adc_buffer.mean), 0, 6 * sizeof(uint16_t));

	adc_buffer.data_index = 0;

	adc_buffer.buffer_write = 0;
	/***********************************************************************************/

	/***********************************************************************************/
	/***********************************************************************************/
	/***********************************************************************************/

	/***********************************************************************************/
	/************************** Inicializacion de los tickers **************************/
	/***********************************************************************************/

	/************************* Ticker para la captura de datos *************************/
	adc_ticker_capture.ms_count = 0;
	adc_ticker_capture.ms_max = 2;
	adc_ticker_capture.calls = 0;
	adc_ticker_capture.priority = TICKER_LOW_PRIORITY;
	adc_ticker_capture.ticker_function = adc_capture;
	adc_ticker_capture.active = TICKER_ACTIVE;

	ticker_new(&adc_ticker_capture);

	/***********************************************************************************/

	/************************** Ticker envio de datos del adc **************************/
	adc_ticker_send_data.ms_count = 0;
	adc_ticker_send_data.ms_max = 255;
	adc_ticker_send_data.calls = 0;
	adc_ticker_send_data.priority = TICKER_LOW_PRIORITY;
	adc_ticker_send_data.ticker_function = adc_send_data;
	adc_ticker_send_data.active = TICKER_NO_ACTIVE;

	ticker_new(&adc_ticker_send_data);
	/***********************************************************************************/

	/***********************************************************************************/
	/***********************************************************************************/
	/***********************************************************************************/
}

void adc_capture(void)
{
	HAL_ADC_Start_DMA(&hadc1, (uint32_t *)(&adc_buffer.data[adc_buffer.data_index]), 6);
}

void adc_set_buffer_send_data(system_ring_buffer_t *buffer, uint32_t ms)
{
	adc_buffer.buffer_write = buffer;

	adc_ticker_send_data.ms_count = 0;
	adc_ticker_send_data.active = TICKER_ACTIVE;

	if (ms == 0)
	{
		adc_ticker_send_data.active = TICKER_NO_ACTIVE;
	}

	else if (ms < 100)
	{
		adc_ticker_send_data.ms_max = 100;
	}

	else
	{
		adc_ticker_send_data.ms_max = ms;
	}
}

void adc_send_data(void)
{
	if (adc_buffer.buffer_write != 0)
	{
		system_write_cmd(adc_buffer.buffer_write, 0xC0, (uint8_t *)(adc_buffer.mean), 12);
	}
}
/***********************************************************************************/
/***********************************************************************************/
/***********************************************************************************/

/**********************************************************************************/
/********************************** Callbacks *************************************/
/**********************************************************************************/
void HAL_ADC_ConvCpltCallback(ADC_HandleTypeDef* hadc)
{
	if (hadc->Instance == ADC1)
	{
		for (system_aux_i = 0 ; system_aux_i < 6 ; system_aux_i++)
		{
			adc_buffer.mean[system_aux_i] =
					(uint16_t)((adc_buffer.mean[system_aux_i] + adc_buffer.data[adc_buffer.data_index][system_aux_i]) / 2.0);
		}

		adc_buffer.data_index++;

		if (adc_buffer.data_index >= ADC_BUFFER_LENGTH)
		{
			adc_buffer.data_index = 0;
		}
	}
}
/***********************************************************************************/
/***********************************************************************************/
/***********************************************************************************/
