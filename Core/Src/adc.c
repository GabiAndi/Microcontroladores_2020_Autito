#include "adc.h"

/**********************************************************************************/
/********************************** Variables *************************************/
/**********************************************************************************/

/*********************************** Tickers **************************************/
ticker_t adc_ticker_capture;
/**********************************************************************************/

/******************************* ADC de la HAL ***********************************/
extern ADC_HandleTypeDef hadc1;
/**********************************************************************************/

/***************************** Bufferes de datos **********************************/
adc_buffer_t adc_buffer;
/**********************************************************************************/

/**********************************************************************************/
/**********************************************************************************/
/**********************************************************************************/

/**********************************************************************************/
/********************************** Funciones *************************************/
/**********************************************************************************/
void adc_init(void)
{
	/***********************************************************************************/
	/************************* Inicializacion de los bufferes **************************/
	/***********************************************************************************/

	/************************** Buffer de captura de datos ADC *************************/
	adc_buffer.mean_aux = 0;

	adc_buffer.send_usb = SYSTEM_ADC_SEND_DATA_OFF;
	adc_buffer.send_esp = SYSTEM_ADC_SEND_DATA_OFF;

	adc_buffer.data_index = 0;
	/***********************************************************************************/

	/***********************************************************************************/
	/***********************************************************************************/
	/***********************************************************************************/

	/***********************************************************************************/
	/************************** Inicializacion de los tickers **************************/
	/***********************************************************************************/

	/************************* Ticker para la captura de datos *************************/
	adc_ticker_capture.ms_count = 0;
	adc_ticker_capture.ms_max = 2;
	adc_ticker_capture.calls = 0;
	adc_ticker_capture.priority = TICKER_LOW_PRIORITY;
	adc_ticker_capture.ticker_function = adc_capture;
	adc_ticker_capture.active = TICKER_ACTIVE;

	ticker_new(&adc_ticker_capture);

	/***********************************************************************************/

	/***********************************************************************************/
	/***********************************************************************************/
	/***********************************************************************************/
}

void adc_capture(void)
{
	HAL_ADC_Start_DMA(&hadc1, (uint32_t *)(&adc_buffer.data[adc_buffer.data_index]), 6);
}
/***********************************************************************************/
/***********************************************************************************/
/***********************************************************************************/

/**********************************************************************************/
/********************************** Callbacks *************************************/
/**********************************************************************************/
void HAL_ADC_ConvCpltCallback(ADC_HandleTypeDef* hadc)
{
	if (hadc->Instance == ADC1)
	{
		adc_buffer.data_index++;

		if (adc_buffer.data_index >= ADC_BUFFER_LENGTH)
		{
			adc_buffer.data_index = 0;
		}
	}
}
/***********************************************************************************/
/***********************************************************************************/
/***********************************************************************************/
