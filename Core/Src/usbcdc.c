#include "usbcdc.h"

/**********************************************************************************/
/********************************** Variables *************************************/
/**********************************************************************************/

/*********************************** Tickers **************************************/
ticker_t usbcdc_ticker_read_time_out;
/**********************************************************************************/

/***************************** Bufferes de datos **********************************/
system_ring_buffer_t usbcdc_buffer_read;
system_ring_buffer_t usbcdc_buffer_write;
/**********************************************************************************/

/*************************** Manejador de comandos ********************************/
system_cmd_manager_t usbcdc_cmd_manager;
/**********************************************************************************/

/***************************** Depuracion via USB *********************************/
extern uint8_t system_usb_debug;
/**********************************************************************************/

/**********************************************************************************/
/**********************************************************************************/
/**********************************************************************************/

/**********************************************************************************/
/********************************** Funciones *************************************/
/**********************************************************************************/
void usbcdc_init(void)
{
	/***********************************************************************************/
	/************************* Inicializacion de los bufferes **************************/
	/***********************************************************************************/

	/**************************** Buffer de lectura del USB ****************************/
	usbcdc_buffer_read.read_index = 0;
	usbcdc_buffer_read.write_index = 0;
	/***********************************************************************************/

	/*************************** Buffer de escritura del USB ***************************/
	usbcdc_buffer_write.read_index = 0;
	usbcdc_buffer_write.write_index = 0;
	/***********************************************************************************/

	/***********************************************************************************/
	/***********************************************************************************/
	/***********************************************************************************/

	/***********************************************************************************/
	/************************* Inicializacion de los comandos **************************/
	/***********************************************************************************/
	usbcdc_cmd_manager.buffer_read = &usbcdc_buffer_read;

	usbcdc_cmd_manager.read_state = 0;
	usbcdc_cmd_manager.read_payload_init = 0;
	usbcdc_cmd_manager.read_payload_length = 0;

	usbcdc_cmd_manager.read_time_out = &usbcdc_ticker_read_time_out;

	usbcdc_cmd_manager.buffer_write = &usbcdc_buffer_write;
	/***********************************************************************************/
	/***********************************************************************************/
	/***********************************************************************************/

	/***********************************************************************************/
	/************************** Inicializacion de los tickers **************************/
	/***********************************************************************************/

	/***************************** Ticker de timeout read  *****************************/
	usbcdc_ticker_read_time_out.ms_max = 100;
	usbcdc_ticker_read_time_out.ms_count = 0;
	usbcdc_ticker_read_time_out.calls = 0;
	usbcdc_ticker_read_time_out.active = TICKER_NO_ACTIVE;
	usbcdc_ticker_read_time_out.priority = TICKER_LOW_PRIORITY;
	usbcdc_ticker_read_time_out.ticker_function = usbcdc_timeout_read;

	ticker_new(&usbcdc_ticker_read_time_out);
	/***********************************************************************************/

	/***********************************************************************************/
	/***********************************************************************************/
	/***********************************************************************************/
}

void usbcdc_read_pending(void)
{
	if (usbcdc_buffer_read.read_index != usbcdc_buffer_read.write_index)
	{
		system_data_package(&usbcdc_cmd_manager);

		usbcdc_buffer_read.read_index++;
	}
}

void usbcdc_write_pending(void)
{
	if (usbcdc_buffer_write.read_index != usbcdc_buffer_write.write_index)
	{
		if (CDC_Transmit_FS((uint8_t *)(&usbcdc_buffer_write.data[usbcdc_buffer_write.read_index]), 1) == USBD_OK)
		{
			usbcdc_buffer_write.read_index++;
		}
	}
}

void usbcdc_timeout_read(void)
{
	usbcdc_ticker_read_time_out.active = TICKER_NO_ACTIVE;

	usbcdc_cmd_manager.read_state = 0;
}
/**********************************************************************************/
/**********************************************************************************/
/**********************************************************************************/
